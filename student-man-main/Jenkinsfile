pipeline {
    agent any

    environment {
        REGISTRY = "farzzit"
        IMAGE = "studentmang-app"
    }

    stages {
        stage('Clone Repository') {
            steps {
                git branch: 'master', url: 'https://github.com/medaminehammami/student-management-devops.git'
            }
        }

        stage('Build with Maven') {
            steps {
                dir('student-man-main') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Dependency Check (SCA)') {
            steps {
                dir('student-man-main') {
                    sh '''
                    echo "üîç Running lightweight OWASP Dependency-Check..."
                    mvn org.owasp:dependency-check-maven:check \
                        -Dformat=HTML \
                        -DskipAssembly=true || true
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'student-man-main/target/dependency-check-report.html', allowEmptyArchive: true
                }
            }
        }

        stage('SonarQube (SAST)') {
            environment {
                SONARQUBE = credentials('sonarqube-token')
            }
            steps {
                dir('student-man-main') {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                        echo "üìä Running SonarQube static code analysis..."
                        mvn sonar:sonar \
                          -Dsonar.projectKey=studentmang-app \
                          -Dsonar.host.url=http://192.168.33.10:9000 \
                          -Dsonar.login=$SONARQUBE || true
                        '''
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('student-man-main') {
                    sh 'docker build -t $REGISTRY/$IMAGE:latest .'
                }
            }
        }

        stage('Trivy Scan (Container Security)') {
            steps {
                dir('student-man-main') {
                    sh '''
                    echo "üß™ Quick Trivy vulnerability scan..."
                    trivy image --quiet --severity HIGH,CRITICAL \
                                --light --timeout 10m \
                                --format table \
                                --output trivy-report.html \
                                $REGISTRY/$IMAGE:latest || true
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'student-man-main/trivy-report.html', allowEmptyArchive: true
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                dir('student-man-main') {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh '''
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push $REGISTRY/$IMAGE:latest || true
                        docker logout
                        '''
                    }
                }
            }
        }

        stage('Generate Summary Report') {
            steps {
                script {
                    def time = sh(script: "date", returnStdout: true).trim()
                    writeFile file: 'student-man-main/summary-report.html', text: """
                    <html><head><title>DevSecOps Report</title></head><body>
                        <h2>‚úÖ DevSecOps Security Pipeline Summary</h2>
                        <ul>
                            <li><a href='target/dependency-check-report.html'>Dependency Check Report</a></li>
                            <li><a href='trivy-report.html'>Trivy Image Scan Report</a></li>
                            <li><a href='http://192.168.33.10:9000/dashboard?id=studentmang-app'>SonarQube Dashboard</a></li>
                        </ul>
                        <p>Generated by Jenkins on ${time}</p>
                    </body></html>
                    """
                }
                archiveArtifacts artifacts: 'student-man-main/summary-report.html', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            echo 'üéØ Pipeline finished. Reports generated successfully.'
        }
    }
}
